---
import type { MarkdownHeading } from "astro";
import Advertisement from "@/components/widget/Advertisement.astro";
import Announcement from "@/components/widget/Announcement.astro";
import Calendar from "@/components/widget/Calendar.astro";
import Categories from "@/components/widget/Categories.astro";
import Profile from "@/components/widget/Profile.astro";
import SidebarTOC from "@/components/widget/SidebarTOC.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import type { WidgetComponentConfig, WidgetComponentType } from "@/types/config";
import { sidebarLayoutConfig } from "@/config";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
	side?: "left" | "right";
}

// 获取当前页面是否为文章详情页（通过 Astro.url 判断）
const isPostPage = Astro.url.pathname.includes("/posts/") || Astro.url.pathname.includes("/post/");
const side = Astro.props.side || "left";

// 组件映射
const componentMap: Record<WidgetComponentType, any> = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	sidebarToc: SidebarTOC,
	advertisement: Advertisement,
	stats: SiteStats,
	calendar: Calendar,
	custom: null,
};

// 根据侧边栏类型过滤允许的组件类型
const getAllowedComponentTypes = (side: string): WidgetComponentType[] => {
	if (side === "left") {
		return ["profile", "announcement", "categories", "tags", "advertisement"];
	} else {
		return ["stats", "calendar", "sidebarToc", "advertisement"];
	}
};

// 获取动画延迟（用于渐进式渲染）
const getAnimationDelay = (index: number): string => {
	return `${100 + index * 50}ms`;
};

// 过滤并排序组件
const filterAndSortComponents = (
	components: WidgetComponentConfig[],
	isPostPage: boolean
) => {
	return components
		.filter((comp) => {
			// 检查是否启用
			if (!comp.enable) return false;
			// 根据页面类型显示
			if (isPostPage && !comp.showOnPostPage) return false;
			if (!isPostPage && !comp.showOnNonPostPage) return false;
			return true;
		})
		.sort((a, b) => {
			// top 位置的组件优先于 sticky
			if (a.position === "top" && b.position === "sticky") return -1;
			if (a.position === "sticky" && b.position === "top") return 1;
			return 0;
		});
};

// 分离 top 和 sticky 位置的组件
const getComponentsByPosition = (components: WidgetComponentConfig[]) => {
	const topComponents = components.filter((c) => c.position === "top");
	const stickyComponents = components.filter((c) => c.position === "sticky");
	return { topComponents, stickyComponents };
};

const className = Astro.props.class;

// 根据 side 属性获取对应的组件列表
const components = side === "left" ? sidebarLayoutConfig.leftComponents : sidebarLayoutConfig.rightComponents;
const allowedTypes = getAllowedComponentTypes(side);

// 过滤并排序组件（只保留该侧边栏允许的组件类型）
const filteredComponents = filterAndSortComponents(
	components.filter((comp) => allowedTypes.includes(comp.type)),
	isPostPage
);

// 分离 top 和 sticky 组件
const { topComponents, stickyComponents } = getComponentsByPosition(filteredComponents);

// 动态构建组件 props
const getComponentProps = (config: WidgetComponentConfig, index: number) => {
	const baseProps: any = {
		class: "onload-animation",
		style: `animation-delay: ${getAnimationDelay(index)}`,
	};

	// 特殊处理 SidebarTOC 组件
	if (config.type === "sidebarToc") {
		return { ...baseProps, headings: Astro.props.headings || [] };
	}

	// 特殊处理 Advertisement 组件
	if (config.type === "advertisement" && config.configId) {
		return { ...baseProps, configId: config.configId };
	}

	return baseProps;
};
---

{topComponents.length > 0 || stickyComponents.length > 0 ? (
	<div id={`${side}-sidebar`} class:list={[className, "flex flex-col w-full gap-4"]}>
		<!-- Top components -->
		{topComponents.map((comp, index) => {
			const Component = componentMap[comp.type];
			if (!Component) return null;
			return (
				<Component {...getComponentProps(comp, index)} />
			);
		})}

		<!-- Sticky components -->
		{stickyComponents.length > 0 && (
			<div
				id={`${side}-sidebar-sticky`}
				class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4"
			>
				{stickyComponents.map((comp, index) => {
					const Component = componentMap[comp.type];
					if (!Component) return null;
					return (
						<Component
							{...getComponentProps(
								comp,
								topComponents.length + index
							)}
						/>
					);
				})}
			</div>
		)}
	</div>
) : null}
