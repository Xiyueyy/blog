---
import type { MarkdownHeading } from "astro";
import Advertisement from "@/components/widget/Advertisement.astro";
import Announcement from "@/components/widget/Announcement.astro";
import Calendar from "@/components/widget/Calendar.astro";
import Categories from "@/components/widget/Categories.astro";
import Profile from "@/components/widget/Profile.astro";
import SidebarTOC from "@/components/widget/SidebarTOC.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import type { WidgetComponentConfig, WidgetComponentType } from "@/types/config";
import { sidebarLayoutConfig } from "@/config";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
	side?: "left" | "right" | "bottom";
}

// 组件映射表
const componentMap: Record<WidgetComponentType, any> = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	sidebarToc: SidebarTOC,
	advertisement: Advertisement,
	stats: SiteStats,
	calendar: Calendar,
};

// 获取当前页面是否为文章详情页
const isPostPage = Astro.url.pathname.includes("/posts/") || Astro.url.pathname.includes("/post/");

// 获取侧边栏位置
const side = Astro.props.side || "left";
const className = Astro.props.class;

// 根据 side 属性获取对应的组件列表
const getComponents = () => {
	if (side === "left") {
		return sidebarLayoutConfig.leftComponents;
	}
	if (side === "right") {
		return sidebarLayoutConfig.rightComponents;
	}
	if (side === "bottom") {
		return sidebarLayoutConfig.mobileBottomComponents;
	}
	return [];
};

// 过滤并排序组件（不再进行 showOnPostPage 过滤，交由客户端处理）
const filterAndSortComponents = (components: WidgetComponentConfig[] | any[]) => {
	return components
		.filter((comp) => {
			// 检查是否启用
			if (!comp.enable) return false;
			// 不进行 showOnPostPage/showOnNonPostPage 过滤，所有启用的组件都渲染
			return true;
		})
		.sort((a, b) => {
			// 如果没有position字段（移动端底部组件），按原顺序排列
			if (!a.position || !b.position) return 0;
			// top 位置的组件优先于 sticky
			if (a.position === "top" && b.position === "sticky") return -1;
			if (a.position === "sticky" && b.position === "top") return 1;
			return 0;
		});
};

// 分离 top 和 sticky 位置的组件
const getComponentsByPosition = (components: WidgetComponentConfig[]) => {
	const topComponents = components.filter((c) => c.position === "top");
	const stickyComponents = components.filter((c) => c.position === "sticky");
	return { topComponents, stickyComponents };
};

// 获取动画延迟（硬编码）
const getAnimationDelay = (index: number): string => {
	const delay = index * 50;
	return `${delay}ms`;
};

// 动态构建组件 props
const getComponentProps = (config: WidgetComponentConfig, index: number) => {
	const baseProps: any = {
		class: "onload-animation",
		style: `animation-delay: ${getAnimationDelay(index)}`,
	};

	// 添加 showOnPostPage 和 showOnNonPostPage 标记class
	if (config.showOnPostPage === false) {
		baseProps.class = `${baseProps.class} widget-hide-on-post`;
	}
	if (config.showOnNonPostPage === false) {
		baseProps.class = `${baseProps.class} widget-hide-on-non-post`;
	}

	// 特殊处理 SidebarTOC 组件
	if (config.type === "sidebarToc") {
		return { ...baseProps, headings: Astro.props.headings || [] };
	}

	// 特殊处理 Advertisement 组件
	if (config.type === "advertisement" && config.configId) {
		return { ...baseProps, configId: config.configId };
	}

	return baseProps;
};

// 获取所有需要渲染的组件
const allComponents = getComponents();
const filteredComponents = filterAndSortComponents(allComponents);
const { topComponents, stickyComponents } = getComponentsByPosition(filteredComponents);

// 对于移动端底部组件，直接使用所有组件，不进行position分组
const isMobileBottom = side === "bottom";
const bottomComponents = isMobileBottom ? filteredComponents : [];
---

{
	(topComponents.length > 0 || stickyComponents.length > 0 || bottomComponents.length > 0) && (
		<div id={`${side}-sidebar`} class:list={[className, "flex flex-col w-full pt-0"]}>
			{/* Mobile bottom components - 直接渲染所有组件，不分组 */}
			{isMobileBottom ? (
				<div class="flex flex-col w-full gap-4">
					{bottomComponents.map((comp, index) => {
						const Component = componentMap[comp.type];
						if (!Component) return null;
						return <Component {...getComponentProps(comp, index)} />;
					})}
				</div>
			) : (
				<>
					{/* Top components */}
					{topComponents.length > 0 && (
						<div class="flex flex-col w-full gap-4 mb-4">
							{topComponents.map((comp, index) => {
								const Component = componentMap[comp.type];
								if (!Component) return null;
								return <Component {...getComponentProps(comp, index)} />;
							})}
						</div>
					)}

					{/* Sticky components */}
					{stickyComponents.length > 0 && (
						<div
							id={`${side}-sidebar-sticky`}
							class:list={[
								"transition-all duration-700 flex flex-col w-full mt-0",
								"sticky",
								topComponents.length > 0 ? "top-4 gap-4" : "top-0",
							]}
						>
							{stickyComponents.map((comp, index) => {
								const Component = componentMap[comp.type];
								if (!Component) return null;
								return (
									<Component
										{...getComponentProps(
											comp,
											topComponents.length + index
										)}
									/>
								);
							})}
						</div>
					)}
				</>
			)}
		</div>
	)
}
